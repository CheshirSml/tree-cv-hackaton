## pipeline для сегментации и классификации деревьев: от разметки до инференса

End-to-end pipeline для автоматической **сегментации** и **классификации пород деревьев**: от первичной разметки до дообучения моделей и инференса.  
Включает два независимых, но взаимодополняющих модуля:
- **Сегментация** на основе YOLOv11-seg для выделения деревьев на изображениях.
- **Классификация пород** по ROI (Region of Interest) с использованием дообученной EfficientNet-B0.

### Основные компоненты:

#### Сегментация (YOLOv11-seg)
- **Валидация изображений**: скрипт для поиска и удаления битых файлов перед обучением.  
- **Конвертация аннотаций**: преобразование пользовательских JSON-разметок в формат YOLO с автоматическим разделением на train/val и генерацией `dataset.yaml`.  
- **Сортировка по классам**: инструмент для группировки изображений и меток по папкам на основе класса (удобно для ревью и доаннотирования).  
- **Автоматическая разметка**: генерация предварительной разметки с помощью предобученной модели и экспорт в COCO-формат для загрузки в CVAT.  
- **Гибкая конфигурация обучения**: полный `train_config` с логированием в Comet.ml, включающий все ключевые гиперпараметры YOLOv11-seg.

#### Классификация пород (EfficientNet-B0)
- **Дообучение EfficientNet-B0**: тонкая настройка предобученной модели под задачу классификации пород по ROI-изображениям.  
- **Инференс-пайплайн**: скрипт для предсказания породы по одному изображению или целой папке.  
- **Полная интеграция с Comet.ml**: логирование гиперпараметров, метрик, архитектуры, кода и сохранение лучших чекпоинтов.  
- **Поддержка воспроизводимости**: фиксированный seed, детерминированные аугментации, сохранение `LabelEncoder` вместе с моделью.

### Улучшения:
- Поддержка обрезанных изображений (`LOAD_TRUNCATED_IMAGES = True`).  
- Воспроизводимость: фиксированный seed, детерминированные настройки.  
- Интеграция с Comet.ml для отслеживания экспериментов.  
- Четкая структура проекта и документированные скрипты.

### Использование:

#### 1. Сегментация
- Подготовить сырые данные → отфильтровать битые изображения  
- Конвертировать JSON-разметку → получить валидный YOLO-датасет  
- Отсортировать по классам → провести ручную проверку в CVAT  
- Сгенерировать авто-разметку → доаннотировать сложные случаи  
- Запустить обучение с полным логированием → сравнить эксперименты в Comet.ml  

#### 2. Классификация пород
- Извлечь ROI из сегментированных изображений (внешний шаг)  
- Подготовить CSV с колонками `file`, `breed`  
- Запустить дообучение EfficientNet-B0 → получить модель классификации  
- Использовать **инференс-пайплайн** для предсказания породы новых деревьев  


### Инференс: как использовать `inference_pipeline`

После завершения обучения и сохранения модели (`best_model.pth`) вы можете использовать **инференс-пайплайн** для предсказания породы дерева по новым изображениям.

#### Требования
- Сохранённая модель 
- Изображение(я) в формате `.jpg` / `.png`
- Установленные зависимости: `torch`, `Pillow`, `scikit-learn`

#### Запуск

**1. Предсказание для одного изображения:**
```bash
python fine\ tuning/inference_efficientnet_b0.py \
  --image_path data/test_samples/tree_001.jpg
  --yolo fine\ tuning/best_model.pth \
  --efficientnet fine\ tuning/best_model.pth \
  --output "results/"
```

**2. Предсказание для всех изображений в папке:**
```bash
python fine\ tuning/inference_efficientnet_b0.py \
  --image_path data/test_samples/
  --yolo fine\ tuning/best_model.pth \
  --efficientnet fine\ tuning/best_model.pth \
  --output "results/"
```

#### Пример вывода:
```text
tree_001.jpg → тополь (confidence: 0.96)
tree_002.jpg → вяз (confidence: 0.89)
...
```

#### Дополнительно
- Скрипт автоматически определяет, используется ли GPU (`cuda`) или CPU.
- Поддерживает изображения с любым количеством каналов (автоматически конвертирует в RGB).
- Для папки результаты выводятся в консоль; при необходимости можно легко модифицировать скрипт для сохранения в CSV.

---

Все скрипты готовы к использованию «из коробки» — достаточно указать пути к данным.

---

### Содержимое папки `fine tuning`

| Файл | Назначение |
|------|-----------|
| **`YOLO_segmentator.py`** | Скрипт для сегментации деревьев с использованием предобученной YOLO-модели; генерирует маски и ROI. |
| **`check_images.py`** | Валидация датасета: проверка и удаление битых или неподдерживаемых изображений. |
| **`comet_train_efficientnet_b0_roi.py`** | Основной скрипт дообучения EfficientNet-B0 на ROI-изображениях с полным логированием в Comet.ml. |
| **`custom_json_to_yolo.py`** | Конвертер пользовательской JSON-разметки (например, из CVAT) в формат YOLO (txt-аннотации + `dataset.yaml`). |
| **`extract_rois_for_breed_only.py`** | Извлекает ROI (области деревьев) из исходных изображений и масок сегментации для последующей классификации пород. |
| **`fine-tune-YOLO.ipynb`** | Jupyter Notebook с экспериментами по дообучению YOLOv11-seg (обучение, валидация, логирование). |
| **`inference_pipeline.py`** | Инференс-пайплайн для EfficientNet-B0: предсказывает породу дерева по одному изображению или папке. |
| **`organize_data.py`** | Сортировка изображений и аннотаций по классам/папкам для удобства ревью и доаннотирования. |
| **`readme.md`** | Документация пайплайна: описание компонентов, инструкции по использованию, структура проекта. |

